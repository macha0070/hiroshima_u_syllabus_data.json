<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒ©ãƒã‚¹ AIæ¨è–¦ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #f4f7f6; color: #333; }
        h1 { text-align: center; color: #2c3e50; }
        
        /* æ¤œç´¢ãƒ‘ãƒãƒ« */
        .search-panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: 1 / -1; }
        
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        
        button { background-color: #3498db; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        /* çµæœè¡¨ç¤º */
        #results-area { margin-top: 20px; }
        .card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 5px solid #ddd; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card h3 { margin: 0 0 5px 0; color: #2c3e50; }
        .card .meta { font-size: 0.85em; color: #7f8c8d; margin-bottom: 8px; }
        .card .desc { font-size: 0.9em; line-height: 1.4; color: #555; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .score-badge { float: right; background: #e74c3c; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8em; font-weight: bold; }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        #loading { text-align: center; margin-top: 50px; font-size: 1.2em; color: #666; }
    </style>
</head>
<body>

    <h1>ğŸ” æˆæ¥­æ¨è–¦AI</h1>

    <div id="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

    <div class="search-panel" id="search-panel" style="display:none;">
        <div>
            <label>é–‹è¬›éƒ¨å±€</label>
            <select id="filter-dept"><option value="">æŒ‡å®šãªã—</option></select>
        </div>
        <div>
            <label>é–‹è¬›ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹</label>
            <select id="filter-campus"><option value="">æŒ‡å®šãªã—</option></select>
        </div>
        <div>
            <label>é–‹è¨­æœŸ</label>
            <select id="filter-term"><option value="">æŒ‡å®šãªã—</option></select>
        </div>
        <div>
            <label>å­¦ç¿’ã®æ®µéš</label>
            <select id="filter-level"><option value="">æŒ‡å®šãªã—</option></select>
        </div>

        <div class="full-width">
            <label>èˆˆå‘³ã®ã‚ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼‰</label>
            <input type="text" id="user-keywords" placeholder="ä¾‹: å›½éš› æ–‡åŒ– ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° å¿ƒç†... (AIãŒé–¢é€£åº¦ã‚’è¨ˆç®—ã—ã¾ã™)">
        </div>

        <div class="full-width">
            <button onclick="executeSearch()">ã“ã®æ¡ä»¶ã§æ¤œç´¢ãƒ»æ¨è–¦ã‚’å®Ÿè¡Œ</button>
        </div>
    </div>

    <div id="results-area"></div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let rawData = {};    // è©³ç´°æƒ…å ± (subject_details...)
        let vectorData = {}; // ãƒ™ã‚¯ãƒˆãƒ«æƒ…å ± (syllabus_vectors...)
        let vocab = {};      // å˜èªè¾æ›¸

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ (ãƒ•ã‚¡ã‚¤ãƒ«åã¯é©å®œåˆã‚ã›ã¦ãã ã•ã„)
        const RAW_FILE = 'subject_details_main_2025-04-03.json';
        const VEC_FILE = 'syllabus_vectors.json';

        // 1. åˆæœŸåŒ–ãƒ»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        Promise.all([
            fetch(RAW_FILE).then(r => r.json()),
            fetch(VEC_FILE).then(r => r.json())
        ]).then(([raw, vec]) => {
            rawData = raw;
            vectorData = vec.courses; // é…åˆ—éƒ¨åˆ†
            vocab = vec.vocabulary;   // è¾æ›¸éƒ¨åˆ†

            initFilters(); // ãƒ•ã‚£ãƒ«ã‚¿ã®é¸æŠè‚¢ã‚’è‡ªå‹•ç”Ÿæˆ
            document.getElementById('loading').style.display = 'none';
            document.getElementById('search-panel').style.display = 'grid';
        }).catch(err => {
            document.getElementById('loading').innerText = "ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚" + err;
        });

        // ãƒ•ã‚£ãƒ«ã‚¿ã®é¸æŠè‚¢ã‚’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•ã§ä½œã‚‹
        function initFilters() {
            const depts = new Set();
            const campuses = new Set();
            const terms = new Set();
            const levels = new Set();

            Object.values(rawData).forEach(d => {
                if(d["é–‹è¬›éƒ¨å±€"]) depts.add(d["é–‹è¬›éƒ¨å±€"]);
                if(d["é–‹è¬›ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹"]) campuses.add(d["é–‹è¬›ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹"]);
                if(d["é–‹è¨­æœŸ"]) terms.add(d["é–‹è¨­æœŸ"]);
                if(d["å­¦ç¿’ã®æ®µéš"]) levels.add(d["å­¦ç¿’ã®æ®µéš"]);
            });

            addOptions("filter-dept", depts);
            addOptions("filter-campus", campuses);
            addOptions("filter-term", terms);
            addOptions("filter-level", levels);
        }

        function addOptions(id, setObj) {
            const select = document.getElementById(id);
            Array.from(setObj).sort().forEach(val => {
                const opt = document.createElement("option");
                opt.value = val;
                opt.innerText = val;
                select.appendChild(opt);
            });
        }

        // 2. æ¤œç´¢å®Ÿè¡Œ
        function executeSearch() {
            const dept = document.getElementById('filter-dept').value;
            const campus = document.getElementById('filter-campus').value;
            const term = document.getElementById('filter-term').value;
            const level = document.getElementById('filter-level').value;
            const keywords = document.getElementById('user-keywords').value;

            // Step 1: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‹ã‚‰ã€Œå­¦ç”Ÿãƒ™ã‚¯ãƒˆãƒ«ã€ã‚’ä½œã‚‹
            const userVector = createVectorFromKeywords(keywords);
            const useVectorSearch = keywords.trim().length > 0; // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒã‚ã‚Œã°ãƒ™ã‚¯ãƒˆãƒ«è¨ˆç®—ã™ã‚‹

            const results = [];

            // Step 2: å…¨æˆæ¥­ã‚’ã‚¹ã‚­ãƒ£ãƒ³
            // (è©³ç´°ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªããƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ™ãƒ¼ã‚¹ã«ãƒ«ãƒ¼ãƒ—ã‚’å›ã™)
            vectorData.forEach(item => {
                const id = item.id;
                const info = rawData[id];

                // 2-1. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ (è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª)
                if (!info) return;
                if (dept && info["é–‹è¬›éƒ¨å±€"] !== dept) return;
                if (campus && info["é–‹è¬›ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹"] !== campus) return;
                if (term && info["é–‹è¨­æœŸ"] !== term) return;
                if (level && info["å­¦ç¿’ã®æ®µéš"] !== level) return;

                // 2-2. ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
                let score = 0;
                if (useVectorSearch) {
                    // ãƒ™ã‚¯ãƒˆãƒ«åŒå£«ã®è·é›¢è¨ˆç®—
                    score = cosineSimilarity(userVector, item.vector);
                } else {
                    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯ãƒ‡ãƒ¼ã‚¿é † (score=0)
                    score = 0;
                }

                results.push({ id: id, info: info, score: score });
            });

            // Step 3: ãƒ©ãƒ³ã‚­ãƒ³ã‚° (ã‚¹ã‚³ã‚¢é«˜ã„é †)
            results.sort((a, b) => b.score - a.score);

            // è¡¨ç¤º
            displayResults(results, useVectorSearch);
        }

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ–‡å­—åˆ—ã‚’ãƒ™ã‚¯ãƒˆãƒ«ã«å¤‰æ›ã™ã‚‹é–¢æ•°
        // "å¿ƒç† ãƒ—ãƒ­ã‚°ãƒ©ãƒ " -> [0, 0, ..., 1, ..., 1, ...]
        function createVectorFromKeywords(text) {
            const dimension = vectorData[0].vector.length; // ãƒ™ã‚¯ãƒˆãƒ«ã®é•·ã•(500)
            const vec = new Array(dimension).fill(0);
            
            // ã‚¹ãƒšãƒ¼ã‚¹ã§åŒºåˆ‡ã‚‹
            const words = text.replace(/ã€€/g, " ").split(" ");
            
            words.forEach(w => {
                // è¾æ›¸ã«ã‚ã‚‹ã‹ç¢ºèª
                if (w in vocab) {
                    const index = vocab[w];
                    vec[index] = 1; // ãã®å˜èªã®æ¬¡å…ƒã‚’ç«‹ã¦ã‚‹
                }
            });
            return vec;
        }

        // ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦è¨ˆç®—
        function cosineSimilarity(vecA, vecB) {
            let dot = 0;
            let normA = 0;
            let normB = 0;
            for (let i = 0; i < vecA.length; i++) {
                dot += vecA[i] * vecB[i];
                normA += vecA[i] * vecA[i];
                normB += vecB[i] * vecB[i];
            }
            if (normA === 0 || normB === 0) return 0;
            return dot / (Math.sqrt(normA) * Math.sqrt(normB));
        }

        // çµæœè¡¨ç¤ºç”¨
        function displayResults(results, isRanked) {
            const area = document.getElementById('results-area');
            area.innerHTML = `<h3>æ¤œç´¢çµæœ: ${results.length}ä»¶</h3>`;

            // é‡ã„ã®ã§ä¸Šä½100ä»¶ã ã‘è¡¨ç¤º
            results.slice(0, 100).forEach(r => {
                const info = r.info;
                // ä¸€è‡´åº¦ãŒä½ã„ã‚‚ã®ã¯è¶³åˆ‡ã‚Šã—ã¦ã‚‚ã„ã„ã‹ã‚‚
                if (isRanked && r.score === 0) return; 

                const scoreDisplay = isRanked ? `<span class="score-badge">ä¸€è‡´åº¦: ${(r.score*100).toFixed(0)}%</span>` : "";
                
                // HTMLç”Ÿæˆ
                const html = `
                    <div class="card">
                        ${scoreDisplay}
                        <h3>${info["æˆæ¥­ç§‘ç›®å"]} <small>(${info["æ‹…å½“æ•™å“¡å"] || "æ‹…å½“ä¸æ˜"})</small></h3>
                        <div class="meta">
                            ${info["é–‹è¬›éƒ¨å±€"]} | ${info["é–‹è¬›ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹"]} | ${info["é–‹è¨­æœŸ"]}
                        </div>
                        <div class="desc">${info["æˆæ¥­ã®ç›®æ¨™ãƒ»æ¦‚è¦ç­‰"] || "æ¦‚è¦ãªã—"}</div>
                    </div>
                `;
                area.innerHTML += html;
            });

            if (results.length === 0) {
                area.innerHTML += "<p>æ¡ä»¶ã«åˆã†æˆæ¥­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>";
            }
        }
    </script>
</body>
</html>